Bootstrap: docker
From: condaforge/mambaforge:22.11.1-4

%post
    echo "Updating Conda and installing dependencies..."
    mamba update --yes --all
    mamba install --yes "boa" "conda-verify"

    echo "Building custom Conda packages..."
    mkdir -p /recipes
    cp -r /mnt/recipes /recipes
    for pkg in rmath traits niflow-nipype1-workflows nitransforms pybids; do
        conda mambabuild --no-anaconda-upload /recipes/$pkg && conda build purge
    done

%post
    echo "Installing additional dependencies..."
    mamba install --yes --use-local "python=3.11" "pip" "nodejs" "rmath" "ants"
    mamba update --yes --all
    bash /mnt/install-requirements.sh --requirements-file /mnt/requirements.txt --requirements-file /mnt/requirements-test.txt
    mamba clean --yes --all --force-pkgs-dirs
    find /opt/conda -follow -type f -name "*.a" -delete
    rm -rf /opt/conda/conda-bld

%post
    echo "Setting up FMRIPREP..."
    mkdir /ext /host
    chmod a+rwx /ext /host

    # Set cache directories
    export XDG_CACHE_HOME="/var/cache"
    export HALFPIPE_RESOURCE_DIR="/var/cache/halfpipe"
    export TEMPLATEFLOW_HOME="/var/cache/templateflow"
    
    mv /home/fmriprep/.cache/templateflow /var/cache

    # Remove older conda and ants installations
    rm -rf /opt/conda /usr/lib/ants

    # Update environment paths
    export PATH="${PATH/\/usr\/local\/miniconda\/bin//opt/conda/bin}"
    export MAMBA_EXE="/opt/conda/bin/mamba"
    export PATH="${PATH//:\/usr\/lib\/ants/}"

    # Copy conda installation
    cp -r /mnt/opt/conda/ /opt/conda/

    # Apply Matplotlib settings
    python -c "from matplotlib import font_manager"
    sed -i '/backend:/s/^#*//;/^backend/s/: .*/: Agg/' $(python -c "import matplotlib; print(matplotlib.matplotlib_fname())")

%post
    echo "Downloading required resources..."
    python /mnt/resource.py

%post
    echo "Installing Halfpipe..."
    cp -r /mnt/halfpipe /tmp
    pip install --no-deps /tmp/halfpipe
    rm -rf ~/.cache/pip /var/cache/pip /tmp/* /var/tmp/*
    sync

%environment
    export PATH="/opt/conda/bin:$PATH"
    export MAMBA_EXE="/opt/conda/bin/mamba"
    export XDG_CACHE_HOME="/var/cache"
    export HALFPIPE_RESOURCE_DIR="/var/cache/halfpipe"
    export TEMPLATEFLOW_HOME="/var/cache/templateflow"

%runscript
    exec /opt/conda/bin/halfpipe "$@"
